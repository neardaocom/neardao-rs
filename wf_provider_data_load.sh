#!/bin/bash

##Â TODO: Automation

### Workflow template data for Workflow provider

GREEN='\033[0;32m'
NC='\033[0m'

# ------------ SETTINGS ------------ #

WFSTART=1
WFCOUNT=5
WID=$1

if [ -z $WID ]; then
    WID='workflow-provider.v1.neardao.testnet';
fi



# ------------ DATA ------------ #
STANDARD_FN_CALLS='{"fncalls":["ft_transfer","ft_transfer_call","nft_transfer","nft_transfer_call","storage_deposit","storage_withdraw","storage_unregister"],"fncall_metadata":[[{"arg_names":["receiver_id","amount","memo"],"arg_types":[{"string":false},{"u128":false},{"string":true}]}],[{"arg_names":["receiver_id","amount","memo","msg"],"arg_types":[{"string":false},{"u128":false},{"string":true},{"string":false}]}],[{"arg_names":["receiver_id","token_id","approval_id","memo"],"arg_types":[{"string":false},{"string":false},{"u64":true},{"string":true}]}],[{"arg_names":["receiver_id","token_id","approval_id","memo","msg"],"arg_types":[{"string":false},{"string":false},{"u64":true},{"string":true},{"string":false}]}],[{"arg_names":["account_id","registration_only"],"arg_types":[{"string":false},{"bool":true}]}],[{"arg_names":["amount"],"arg_types":[{"u128":true}]}],[{"arg_names":["force"],"arg_types":[{"string":false}]}]]}'

WF_ADD_TEMPLATE_SETTINGS='{"allowed_proposers":[{"Group":1}],"allowed_voters":{"Group":1},"activity_rights":[[],[{"Group":1}]],"transition_limits":[[{"to":1,"limit":1}]],"scenario":"Democratic","duration":60,"quorum":51,"approve_threshold":20,"spam_threshold":80,"vote_only_once":true,"deposit_propose":"1000000000000000000000000","deposit_vote":"1","deposit_propose_return":0,"constants":null}'

# WFT - WFADD1
WF1='{"code":"wf_add","version":"1","auto_exec":true,"need_storage":false,"activities":["Init",{"Activity":{"code":"wf_add","actions":[{"exec_condition":null,"validators":[],"action_data":{"FnCall":{"id":{"Dynamic":[{"ConstPropSettings":"provider_id"},"wf_template"]},"tgas":30,"deposit":null,"binds":[{"key":"id","key_src":{"Src":{"ConstPropSettings":"workflow_id"}},"collection_data":null}]}},"postprocessing":{"instructions":["StoreWorkflow"]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"Automatic","postprocessing":null,"is_sync":false}}],"expressions":[],"transitions":[[{"activity_id":1,"cond":null,"time_from_cond":null,"time_to_cond":null}]],"constants":{"Map":{}},"end":[1]}'
WF1FNS='[["workflow-provider.v1.neardao.testnet","wf_template"]]'
WF1FNMETA='[[{"arg_names":["id"],"arg_types":[{"u64":false}]}]]'
WF1STDFNS='[]'

# WFT - SKYWARD1
WF2='{"code":"skyward1","version":"1","auto_exec":false,"need_storage":true,"activities":["Init",{"Activity":{"code":"register_tokens","actions":[{"exec_condition":null,"validators":[],"action_data":{"FnCall":{"id":{"Static":["skyward.v1.neardao.testnet","register_tokens"]},"tgas":30,"deposit":{"ConstsTpl":"deposit_register_tokens"},"binds":[{"key":"token_account_ids","key_src":{"Expr":{"args":[{"ConstsTpl":"account_wnear"},{"ConstPropSettings":"offered_token"}],"expr_id":0}},"collection_data":null}]}},"postprocessing":{"instructions":[{"StoreValue":["pp_1_result",{"bool":true}]}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":false}},{"Activity":{"code":"storage_deposit","actions":[{"exec_condition":null,"validators":[],"action_data":{"FnCall":{"id":{"StandardStatic":["wnear.v1.neardao.testnet","storage_deposit"]},"tgas":10,"deposit":{"ConstsTpl":"deposit_storage"},"binds":[{"key":"account_id","key_src":{"Src":{"ConstsTpl":"account_skyward"}},"collection_data":null}]}},"postprocessing":null,"must_succeed":false,"optional":true},{"exec_condition":null,"validators":[],"action_data":{"FnCall":{"id":{"StandardDynamic":[{"ConstPropSettings":"offered_token"},"storage_deposit"]},"tgas":10,"deposit":{"ConstsTpl":"deposit_storage"},"binds":[{"key":"account_id","key_src":{"Src":{"ConstsTpl":"account_skyward"}},"collection_data":null}]}},"postprocessing":null,"must_succeed":false,"optional":true}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":false}},{"Activity":{"code":"transfer_tokens","actions":[{"exec_condition":null,"validators":[],"action_data":{"FnCall":{"id":{"StandardDynamic":[{"ConstPropSettings":"offered_token"},"ft_transfer_call"]},"tgas":100,"deposit":{"ConstsTpl":"deposit_ft_transfer_call"},"binds":[{"key":"receiver_id","key_src":{"Src":{"ConstsTpl":"account_skyward"}},"collection_data":null},{"key":"amount","key_src":{"Src":{"ConstPropSettings":"offered_amount"}},"collection_data":null},{"key":"msg","key_src":{"Src":{"ConstsTpl":"ft_transfer_call_msg"}},"collection_data":null},{"key":"memo","key_src":{"Value":"null"},"collection_data":null}]}},"postprocessing":{"instructions":[{"StoreValue":["pp_3_result",{"bool":true}]}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":false}},{"Activity":{"code":"sale_create","actions":[{"exec_condition":null,"validators":[],"action_data":{"FnCall":{"id":{"Static":["skyward.v1.neardao.testnet","sale_create"]},"tgas":50,"deposit":{"ConstsTpl":"deposit_sale_create"},"binds":[{"key":"sale.permissions_contract_id","key_src":{"Src":{"Const":0}},"collection_data":null},{"key":"token_account_id","key_src":{"Src":{"ConstPropSettings":"offered_token"}},"collection_data":{"prefixes":["sale.out_tokens"],"collection_binding_type":{"ForceSame":1}}},{"key":"balance","key_src":{"Src":{"ConstPropSettings":"offered_amount"}},"collection_data":{"prefixes":["sale.out_tokens"],"collection_binding_type":{"ForceSame":1}}},{"key":"referral_bpt","key_src":{"Value":"null"},"collection_data":{"prefixes":["sale.out_tokens"],"collection_binding_type":{"ForceSame":1}}},{"key":"sale.in_token_account_id","key_src":{"Src":{"ConstsTpl":"account_wnear"}},"collection_data":null},{"key":"sale.start_time","key_src":{"Src":{"ConstAction":"start_time"}},"collection_data":null},{"key":"sale.duration","key_src":{"Src":{"ConstAction":"duration"}},"collection_data":null}]}},"postprocessing":{"instructions":[{"StoreFnCallResult":["skyward_auction_id",{"u64":false}]}]},"must_succeed":true,"optional":false}],"automatic":false,"terminal":"Automatic","postprocessing":null,"is_sync":false}}],"expressions":[{"Fn":"ToArray"},{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"Eqs"}}],"terms":[{"Arg":0},{"Value":{"bool":true}}]}}],"transitions":[[{"activity_id":1,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":2,"cond":{"args":[{"Storage":"pp_1_result"}],"expr_id":1},"time_from_cond":null,"time_to_cond":null},{"activity_id":3,"cond":{"args":[{"Storage":"pp_1_result"}],"expr_id":1},"time_from_cond":null,"time_to_cond":null}],[{"activity_id":3,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":4,"cond":{"args":[{"Storage":"pp_3_result"}],"expr_id":1},"time_from_cond":null,"time_to_cond":null}]],"constants":{"Map":{"deposit_register_tokens":{"u128":"20000000000000000000000"},"deposit_storage":{"u128":"1250000000000000000000"},"deposit_sale_create":{"u128":"3000000000000000000000000"},"ft_transfer_call_msg":{"string":"\\\"AccountDeposit\\\""},"deposit_ft_transfer_call":{"u128":"1"},"account_skyward":{"string":"skyward.v1.neardao.testnet"},"account_wnear":{"string":"wnear.v1.neardao.testnet"}}},"end":[4]}'
WF2FNS='[["skyward.v1.neardao.testnet","register_tokens"],["skyward.v1.neardao.testnet","sale_create"]]'
WF2FNMETA='[[{"arg_names":["token_account_ids"],"arg_types":["vec_string"]}],[{"arg_names":["sale"],"arg_types":[{"object":1}]},{"arg_names":["title","url","permissions_contract_id","out_tokens","in_token_account_id","start_time","duration"],"arg_types":[{"string":false},{"string":true},{"string":true},{"vec_object":2},{"string":false},{"u128":false},{"u128":false}]},{"arg_names":["token_account_id","balance","referral_bpt"],"arg_types":[{"string":false},{"u128":false},{"u64":true}]}]]'
WF2STDFNS='["storage_deposit","ft_transfer_call"]'

# WFT - BOUNTY1
WF3='{"code":"bounty1","version":"1","auto_exec":false,"need_storage":true,"activities":["Init",{"Activity":{"code":"event_checkin","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"Event","code":"event_checkin","expected_input":null,"required_deposit":null,"binds":[]}},"postprocessing":{"instructions":[{"StoreDynValue":["account_id_applied",{"Const":2}]}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":true}},{"Activity":{"code":"event_unrealized","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"Event","code":"event_unrealized","expected_input":null,"required_deposit":null,"binds":[]}},"postprocessing":{"instructions":[{"DeleteKey":"account_id_applied"}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":true}},{"Activity":{"code":"event_approve","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"Event","code":"event_approve","expected_input":null,"required_deposit":null,"binds":[]}},"postprocessing":{"instructions":[{"StoreDynValue":["approved_by",{"Const":2}]},{"StoreDynValue":["checkin_accepted",{"User":"checkin_accepted"}]}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":true}},{"Activity":{"code":"event_done","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"Event","code":"event_done","expected_input":[["result",{"string":false}]],"required_deposit":null,"binds":[]}},"postprocessing":{"instructions":[{"StoreDynValue":["event_done_result",{"User":"result"}]}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":true}},{"Activity":{"code":"event_done_approve","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"Event","code":"event_done_approve","expected_input":[["result_evaluation",{"string":false}]],"required_deposit":null,"binds":[]}},"postprocessing":{"instructions":[{"StoreDynValue":["event_done_approved_by",{"Const":2}]},{"StoreDynValue":["event_done_result_evaluation",{"User":"result_evaluation"}]}]},"must_succeed":true,"optional":false}],"automatic":true,"terminal":"NonTerminal","postprocessing":null,"is_sync":true}},{"Activity":{"code":"send_near","actions":[{"exec_condition":null,"validators":[{"Object":{"expression_id":0,"key_src":[{"User":"amount_near"},{"ConstPropSettings":"max_offered_near_amount"}]}},{"Object":{"expression_id":1,"key_src":[{"User":"receiver_id"},{"Storage":"account_id_applied"}]}}],"action_data":{"SendNear":[{"Storage":"account_id_applied"},{"User":"amount_near"}]},"postprocessing":null,"must_succeed":true,"optional":false}],"automatic":true,"terminal":"Automatic","postprocessing":null,"is_sync":false}}],"expressions":[{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"GtE"}}],"terms":[{"Arg":0},{"Arg":1}]}},{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"Eqs"}}],"terms":[{"Arg":0},{"Arg":1}]}},{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"Eqs"}},{"operands_ids":[2,3],"op_type":{"Rel":"Eqs"}},{"operands_ids":[0,1],"op_type":{"Log":"And"}}],"terms":[{"Arg":0},{"Value":{"bool":true}},{"Arg":1},{"Arg":2}]}},{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"Eqs"}}],"terms":[{"Arg":0},{"Value":{"bool":false}}]}},{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"Eqs"}}],"terms":[{"Arg":0},{"Arg":1}]}}],"transitions":[[{"activity_id":1,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":3,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":1,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":1,"cond":{"args":[{"Storage":"checkin_accepted"}],"expr_id":3},"time_from_cond":null,"time_to_cond":null},{"activity_id":2,"cond":{"args":[{"Storage":"account_id_applied"},{"Const":2}],"expr_id":1},"time_from_cond":null,"time_to_cond":null},{"activity_id":4,"cond":{"args":[{"Storage":"checkin_accepted"},{"Storage":"account_id_applied"},{"Const":2}],"expr_id":2},"time_from_cond":null,"time_to_cond":null}],[{"activity_id":5,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":6,"cond":null,"time_from_cond":null,"time_to_cond":null}]],"constants":{"Map":{}},"end":[6]}'
WF3FNS='[]'
WF3FNMETA='[]'
WF3STDFNS='[]'

# WFT - REWARD1
WF4='{"code":"reward1","version":"1","auto_exec":false,"need_storage":true,"activities":["Init",{"Activity":{"code":"treasury_add_partition","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"TreasuryAddPartition","code":null,"expected_input":null,"required_deposit":null,"binds":[]}},"postprocessing":null,"must_succeed":true,"optional":false}],"automatic":false,"terminal":"NonTerminal","postprocessing":null,"is_sync":true}},{"Activity":{"code":"reward_add_wage","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"RewardAdd","code":null,"expected_input":null,"required_deposit":null,"binds":[]}},"postprocessing":null,"must_succeed":true,"optional":false}],"automatic":false,"terminal":"Automatic","postprocessing":null,"is_sync":true}},{"Activity":{"code":"reward_add_user_activity","actions":[{"exec_condition":null,"validators":[],"action_data":{"Action":{"name":"RewardAdd","code":null,"expected_input":null,"required_deposit":null,"binds":[]}},"postprocessing":null,"must_succeed":true,"optional":false}],"automatic":false,"terminal":"Automatic","postprocessing":null,"is_sync":true}}],"expressions":[],"transitions":[[{"activity_id":1,"cond":null,"time_from_cond":null,"time_to_cond":null}],[{"activity_id":2,"cond":null,"time_from_cond":null,"time_to_cond":null},{"activity_id":3,"cond":null,"time_from_cond":null,"time_to_cond":null}]],"constants":{"Map":{}},"end":[2,3]}'
WF4FNS='[]'
WF4FNMETA='[]'
WF4STDFNS='[]'

# WFT - TRADE1
WF5='{"code":"trade1","version":"1","auto_exec":false,"need_storage":true,"activities":["Init",{"Activity":{"code":"send_near","actions":[{"exec_condition":{"args":[{"ConstPropSettings":"required_token_id"},{"Storage":"token_id"},{"ConstPropSettings":"required_token_amount"},{"Storage":"amount"}],"expr_id":0},"validators":[],"action_data":{"SendNear":[{"Storage":"sender_id"},{"ConstPropSettings":"offered_near_amount"}]},"postprocessing":null,"must_succeed":true,"optional":false}],"automatic":true,"terminal":"Automatic","postprocessing":null,"is_sync":false}}],"expressions":[{"Boolean":{"operators":[{"operands_ids":[0,1],"op_type":{"Rel":"Eqs"}},{"operands_ids":[2,3],"op_type":{"Rel":"Eqs"}},{"operands_ids":[0,1],"op_type":{"Log":"And"}}],"terms":[{"Arg":0},{"Arg":1},{"Arg":2},{"Arg":3}]}}],"transitions":[[{"activity_id":1,"cond":null,"time_from_cond":null,"time_to_cond":null}]],"constants":{"Map":{}},"end":[1]}'
WF5FNS='[]'
WF5FNMETA='[]'
WF5STDFNS='[]'

## ------------ LOAD ------------ #

echo "\n\n------ Loading workflow templates to provider: ${GREEN} $WID ${NC} ------\n\n"
for ((i=$WFSTART;i<$WFSTART+$WFCOUNT;i++))
  do 
    wf_val="WF$i"
    wf_fns="WF"$i"FNS"
    wf_std_fns="WF"$i"STDFNS"
    wf_fnmeta="WF"$i"FNMETA"
    if [ ! -z "${!wf_val}" ]; then
      echo "${GREEN}------ Adding WF $i ------${NC}\n"
      near call $WID workflow_add '{"workflow": '${!wf_val}', "fncalls": '${!wf_fns}',"standard_fncalls": '${!wf_std_fns}', "fncall_metadata": '${!wf_fnmeta}',"help":null}' --accountId=$WID
    fi
 done